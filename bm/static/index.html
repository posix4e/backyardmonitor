<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Backyard Monitor</title>
    <link rel="icon"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
    <style>
      .muted { color:#666; }
      label { display:block; margin-top:6px; }
      input[type=number] { width: 6em; }
      /* Removed floating tooltip; use side panel instead */
      .panel-section { margin-top:16px; }
      .list { max-height:200px; overflow:auto; border:1px solid #eee; border-radius:6px; padding:4px; }
      .list-item { padding:4px 6px; border-radius:4px; cursor:pointer; display:flex; gap:6px; align-items:center; }
      .list-item:hover { background:#f5f7fa; }
      .list-item.active { background:#e8f1ff; }
      .pulse-indicator { position:absolute; border-radius:6px; box-shadow:0 0 0 2px rgba(255,0,0,0.5), 0 0 18px rgba(255,0,0,0.35); animation:pulse 1s ease-out infinite; pointer-events:none; z-index:9; }
      @keyframes pulse { 0%{ box-shadow:0 0 0 2px rgba(255,0,0,0.6), 0 0 0 rgba(255,0,0,0.0);} 70%{ box-shadow:0 0 0 6px rgba(255,0,0,0.2), 0 0 18px rgba(255,0,0,0.4);} 100%{ box-shadow:0 0 0 2px rgba(255,0,0,0.6), 0 0 0 rgba(255,0,0,0.0);} }
      .change-button { position:absolute; right:6px; top:6px; cursor:pointer; }
      .change-button.star { width:28px; height:28px; border:none; border-radius:50%;
        display:flex; align-items:center; justify-content:center;
        background: conic-gradient(#ff0040, #ff7a00, #ffd400, #38e600, #00d5ff, #6733ff, #ff33cc, #ff0040);
        color:#ffffff; font-size:16px; line-height:1; box-shadow:0 2px 8px rgba(0,0,0,0.25); }
      .compare-popup { position:absolute; background:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2); padding:8px; z-index:20; }
      .compare-popup .row { display:flex; gap:8px; }
      .compare-popup img { max-width:220px; border-radius:6px; border:1px solid #eee; }
      .compare-close { position:absolute; right:6px; top:6px; background:transparent; border:none; font-size:14px; cursor:pointer; }
      .delta-badge { position:absolute; left:6px; top:6px; background:#111; color:#fff; font-size:11px; padding:2px 6px; border-radius:10px; opacity:0.85; }
      #canvasWrap { position: relative; display: inline-block; }
      /* Improve mobile interactions */
      canvas { touch-action: none; -webkit-user-select: none; user-select: none; }
    </style>
  </head>
  <body>
    <h1>Backyard Monitor</h1>
    <div class="controls">
      <button id="btnStart" onclick="control('start')">Start</button>
      <button id="btnStop" onclick="control('stop')">Stop</button>
      <span class="muted">Spots: click/tap to add or select; drag to move; arrows to nudge; Delete to remove; drag vertices to reshape; Shift+click edge to add a point; double‑click a spot (or list entry) for details.</span>
    </div>
    <div class="row" style="margin-top:12px;">
      <div class="card">
        <div>
          <strong>Live Frame</strong>
        </div>
        <div id="canvasWrap">
          <canvas id="canvas" width="640" height="360"></canvas>
        </div>
        <div class="muted" id="status"></div>
        <div style="margin-top:8px;
                    display:flex;
                    gap:8px;
                    align-items:center;
                    flex-wrap: wrap">
          <button onclick="saveZones()">Save Zones</button>
          <button onclick="clearSpots()">Clear Spots</button>
          <button id="sizeBtn" onclick="toggleSize()">Expand</button>
        </div>
      </div>
      <div class="card" style="min-width:420px;">
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <div>
            <strong>Data</strong>
          </div>
        </div>
        <div id="panel_data">
          <div class="panel-section">
            <div style="font-weight:600; margin-bottom:4px;">Spots</div>
            <div style="display:flex;
                        gap:6px;
                        align-items:center;
                        margin-bottom:6px;
                        flex-wrap:wrap">
              <input id="spot_search"
                     type="text"
                     placeholder="Search spots..."
                     style="flex:1;
                            min-width:200px"
                     oninput="renderSpotList()" />
              <button onclick="compareSelected()"
                      title="Compare selected (prev vs current)">★ Compare</button>
            </div>
            <div id="spot_list" class="list"></div>
            <div id="spot_editor" style="margin-top:8px; display:none;">
              <div style="margin-bottom:6px;">
                Selected Spot <span id="spot_edit_id" class="muted"></span>
              </div>
              <div style="display:flex;
                          gap:12px;
                          align-items:center;
                          flex-wrap:wrap;
                          margin-top:6px">
                <span id="spot_size" class="muted" style="font-size:12px;"></span>
              </div>
              <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                <button onclick="openSpotDetails()">Open Details</button>
              </div>
            </div>
          </div>
          <div>
            <strong>Data</strong>
          </div>
          <div style="margin-top:8px;">
            <label for="zones_json"
                   style="font-weight:600;
                          margin-bottom:4px;
                          display:block">Zones (JSON)</label>
            <textarea id="zones_json"
                      aria-label="Zones JSON"
                      style="width: 380px;
                             height: 180px;
                             font-family: ui-monospace, SFMono-Regular, Menlo, monospace"></textarea>
            <div style="margin-top:6px; display:flex; gap:8px; flex-wrap: wrap;">
              <button onclick="loadZonesJson()">Load Zones</button>
              <button onclick="saveZonesJson()">Save Zones</button>
            </div>
          </div>
          <div style="margin-top:16px;">
            <div style="font-weight:600; margin-bottom:4px;">Events</div>
            <div style="margin-bottom:6px;
                        display:flex;
                        gap:8px;
                        align-items:center;
                        flex-wrap:wrap">
              <button onclick="loadEvents()">Load Events</button>
              <label for="events_limit">Limit</label>
              <input type="number"
                     id="events_limit"
                     name="events_limit"
                     value="50"
                     min="1"
                     style="width:70px" />
              <label class="muted" title="Only show events marked significant by LLM">
                <input type="checkbox" id="events_sig_only" checked />
                Significant only
              </label>
              <button style="margin-left:auto; color:#a00;" onclick="clearAllEvents()">
                Clear All Events
              </button>
            </div>
            <div id="events_list"
                 style="max-height:220px;
                        overflow:auto;
                        border:1px solid #eee;
                        padding:6px;
                        border-radius:6px"></div>
            <div id="event_editor" style="margin-top:8px; display:none;">
              <div style="margin-bottom:4px;">
                Editing Event <span id="ev_id"></span>
              </div>
              <label for="ev_kind">Kind</label>
              <input type="text" id="ev_kind" name="ev_kind" style="width:200px;" />
              <label for="ev_ts">Timestamp</label>
              <input type="number"
                     step="0.001"
                     id="ev_ts"
                     name="ev_ts"
                     style="width:200px" />
              <label for="ev_meta">Meta (JSON)</label>
              <textarea id="ev_meta"
                        name="ev_meta"
                        style="width: 380px;
                               height: 120px;
                               font-family: ui-monospace, monospace"></textarea>
              <div style="margin-top:6px; display:flex; gap:8px;">
                <button onclick="saveEvent()">Save Event</button>
                <button onclick="deleteEvent()" style="color:#b00000;">Delete Event</button>
              </div>
            </div>
          </div>
          <div style="margin-top:16px;">
            <div style="font-weight:600; margin-bottom:4px;">Perception</div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label for="detector_method">Detector</label>
              <select id="detector_method" name="detector_method">
                <option value="phash">pHash</option>
                <option value="roi_diff">ROI Diff</option>
              </select>
              <span class="muted">Configure thresholds below</span>
            </div>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px;">
              <label for="ui_frame_refresh_ms">Live frame refresh (ms)</label>
              <input type="number" id="ui_frame_refresh_ms" name="ui_frame_refresh_ms" value="10000" min="500" step="500" style="width:120px" />
              <label for="llm_burst_window_ms" title="Only the strongest event is sent to LLM within this window">
                LLM burst window (ms)
              </label>
              <input type="number" id="llm_burst_window_ms" name="llm_burst_window_ms" value="1500" min="200" step="100" style="width:120px" />
            </div>
            <div id="phash_params"
                 style="display:flex;
                        gap:8px;
                        align-items:center;
                        flex-wrap:wrap;
                        margin-top:6px">
              <label for="phash_bits">Change threshold</label>
              <input type="number"
                     id="phash_bits"
                     name="phash_bits"
                     value="14"
                     min="0"
                     max="64"
                     style="width:80px" />
              <label for="phash_ms">Stable window (ms)</label>
              <input type="number"
                     id="phash_ms"
                     name="phash_ms"
                     value="1200"
                     min="0"
                     style="width:120px" />
            </div>
            <div id="roidiff_params"
                 style="display:none;
                        gap:8px;
                        align-items:center;
                        flex-wrap:wrap;
                        margin-top:6px">
              <label for="roi_diff_threshold">Change ratio</label>
              <input type="number"
                     step="0.001"
                     id="roi_diff_threshold"
                     name="roi_diff_threshold"
                     value="0.02"
                     min="0"
                     max="1"
                     style="width:120px" />
              <label for="roi_diff_min_pixels">Min pixels</label>
              <input type="number"
                     id="roi_diff_min_pixels"
                     name="roi_diff_min_pixels"
                     value="600"
                     min="0"
                     step="1"
                     style="width:120px" />
              <label for="roi_diff_alpha">EMA alpha</label>
              <input type="number"
                     step="0.01"
                     id="roi_diff_alpha"
                     name="roi_diff_alpha"
                     value="0.05"
                     min="0"
                     max="1"
                     style="width:120px" />
              <label for="roi_diff_cooldown_ms">Cooldown (ms)</label>
              <input type="number"
                     id="roi_diff_cooldown_ms"
                     name="roi_diff_cooldown_ms"
                     value="0"
                     min="0"
                     step="100"
                     style="width:120px" />
              <label for="phash_ms">Stable window (ms)</label>
              <input type="number"
                     id="phash_ms"
                     name="phash_ms"
                     value="1200"
                     min="0"
                     style="width:120px" />
            </div>
            <div style="margin-top:8px;">
              <button onclick="savePerception()">Apply</button>
            </div>
          </div>
          <div style="margin-top:16px;">
            <div style="font-weight:600; margin-bottom:4px;">Images</div>
            <div style="display:flex;
                        gap:8px;
                        align-items:center;
                        flex-wrap:wrap;
                        margin-bottom:6px">
              <button onclick="loadImagesSummary()">Refresh Summary</button>
              <button onclick="cleanupOrphans()">Cleanup Orphans</button>
              <button onclick="loadThumbnails()">Show Latest Thumbnails</button>
              <label class="muted" title="Only show LLM-significant changes">
                <input type="checkbox" id="thumb_sig_only" checked />
                Significant only
              </label>
            </div>
            <div id="images_summary" class="muted"></div>
            <div id="thumb_grid"
                 style="margin-top:8px;
                        display:flex;
                        flex-wrap:wrap;
                        gap:8px;
                        max-height:320px;
                        overflow:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>
<script src="/static/js/index.js"></script>
</body>
</html>
